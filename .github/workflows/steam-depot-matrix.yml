name: DepotDownloaderMod EXE Downloader

on:
  workflow_dispatch:
    inputs:
      pubfileids:
        description: "Comma-separated Workshop pubfile IDs"
        required: true

      app_id:
        description: "Steam App ID (default = 431960)"
        required: false
        default: "431960"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      ids: ${{ steps.split.outputs.ids }}

    steps:
      - id: split
        run: |
          ids=$(echo "${{ github.event.inputs.pubfileids }}" | awk -F',' '{printf("["); for(i=1;i<=NF;i++){printf("\""$i"\""); if(i<NF) printf(",");} printf("]")}')
          echo "ids=$ids" >> $GITHUB_OUTPUT

  download:
    needs: prepare
    runs-on: windows-latest
    strategy:
      matrix:
        pubfileid: ${{ fromJson(needs.prepare.outputs.ids) }}

    steps:
      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Download DepotDownloaderMod Release
        run: |
          curl -L -o release.rar https://github.com/SteamAutoCracks/DepotDownloaderMod/releases/latest/download/Release.rar

      - name: Extract RAR
        run: |
          7z x release.rar -orelease

      - name: Run DepotDownloaderMod.exe
        run: |
          release/Release/net9.0/DepotDownloaderMod.exe ^
            -app ${{ github.event.inputs.app_id }} ^
            -pubfile ${{ matrix.pubfileid }} ^
            -verify-all ^
            -username "ruiiixx" ^
            -password "S67GBTB83D3Y"

      - name: Upload ONLY depots folder
        uses: actions/upload-artifact@v4
        with:
          name: depot_${{ matrix.pubfileid }}
          path: depots
