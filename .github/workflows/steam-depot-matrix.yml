name: DepotDownloaderMod EXE Downloader

on:
  workflow_dispatch:
    inputs:
      pubfileids:
        description: "Comma-separated Workshop pubfile IDs"
        required: true

      app_id:
        description: "Steam App ID"
        required: false
        default: "431960"

jobs:
  download:
    runs-on: windows-latest

    steps:
      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Download DepotDownloaderMod Release
        run: |
          curl -L -o release.rar https://github.com/SteamAutoCracks/DepotDownloaderMod/releases/latest/download/Release.rar

      - name: Extract RAR
        run: |
          7z x release.rar -orelease

      - name: Process Each pubfile ID
        shell: pwsh
        run: |
          $ids = "${{ github.event.inputs.pubfileids }}".Split(",")
          $output = "output/431960"
          New-Item -ItemType Directory -Force -Path $output | Out-Null

          foreach ($id in $ids) {
            $trimmed = $id.Trim()
            echo "Processing pubfile ID: $trimmed"

            # Run downloader
            & release/Release/net9.0/DepotDownloaderMod.exe `
              -app ${{ github.event.inputs.app_id }} `
              -pubfile $trimmed `
              -verify-all `
              -username "ruiiixx" `
              -password "S67GBTB83D3Y"

            # Find depot folders: depots/431960/*
            $depotPath = Get-ChildItem -Path "depots/431960" -Directory -ErrorAction SilentlyContinue

            foreach ($folder in $depotPath) {
              # Allow duplicates: add incremental suffix
              $counter = 1
              $dest = "$output/$($folder.Name)"
              while (Test-Path $dest) {
                $counter++
                $dest = "$output/$($folder.Name)_$counter"
              }

              Copy-Item -Path $folder.FullName -Destination $dest -Recurse -Force
            }

            # Cleanup depots folder so next run is clean
            Remove-Item -Recurse -Force "depots" -ErrorAction SilentlyContinue
          }

      - name: Upload all downloaded content
        uses: actions/upload-artifact@v4
        with:
          name: depotdownload
          path: output
