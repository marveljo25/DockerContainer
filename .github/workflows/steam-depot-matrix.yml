name: Wallpaper Engine Workshop Downloader

on:
  workflow_dispatch:
    inputs:
      workshop_ids:
        description: "Comma-separated Workshop IDs (e.g., 1562118779,2259807269)"
        required: true
      app_id:
        description: "Wallpaper Engine AppID"
        required: true
        default: "431960"

jobs:
  download-workshop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Pull SteamCMD Docker image
        run: docker pull cm2network/steamcmd

      - name: Prepare workspace folder
        run: mkdir -p ${{ github.workspace }}/workshop_content

      - name: Download Workshop items sequentially
        run: |
          set -e

          STEAM_USERNAME="ruiiixx"
          STEAM_PASSWORD="S67GBTB83D3Y"
          APPID="${{ github.event.inputs.app_id }}"
          WORKSHOP_IDS="${{ github.event.inputs.workshop_ids }}"

          # Split comma-separated IDs into array
          IFS=',' read -ra IDS <<< "$WORKSHOP_IDS"

          for WORKSHOPID in "${IDS[@]}"; do
            echo "Downloading Workshop ID $WORKSHOPID..."
            CONTAINER_NAME="steam_${WORKSHOPID}_$$"

            # Run SteamCMD in Docker with force_install_dir
            docker run --name $CONTAINER_NAME \
              cm2network/steamcmd \
              /home/steam/steamcmd/steamcmd.sh \
              +force_install_dir "/home/steam/Steam/steamapps/workshop/content/$APPID/$WORKSHOPID" \
              +login $STEAM_USERNAME $STEAM_PASSWORD \
              +workshop_download_item $APPID $WORKSHOPID validate \
              +quit

            # Flatten files into GitHub workspace
            DEST_DIR="${{ github.workspace }}/workshop_content/$WORKSHOPID"
            mkdir -p "$DEST_DIR"

            # Copy contents from container
            docker cp $CONTAINER_NAME:/home/steam/Steam/steamapps/workshop/content/$APPID/$WORKSHOPID/. "$DEST_DIR/"

            # Remove nested Steam folders if exist
            if [ -d "$DEST_DIR/steamapps" ]; then
              mv "$DEST_DIR/steamapps/workshop/content/$APPID/$WORKSHOPID/"* "$DEST_DIR/"
              rm -rf "$DEST_DIR/steamapps"
            fi

            # Remove container
            docker rm $CONTAINER_NAME

            echo "Downloaded $WORKSHOPID successfully."
          done

      - name: Upload all Workshop items as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wallpaper-workshop-items
          path: ${{ github.workspace }}/workshop_content
          retention-days: 1
