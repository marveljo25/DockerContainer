name: Wallpaper Engine Workshop Downloader

on:
  workflow_dispatch:
    inputs:
      workshop_ids:
        description: "Comma-separated Workshop IDs (e.g., 1562118779,1562119999)"
        required: true
        default: "1562118779"
      app_id:
        description: "Wallpaper Engine AppID"
        required: true
        default: "431960"

jobs:
  download-workshop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Pull SteamCMD Docker image
        run: docker pull cm2network/steamcmd

      - name: Prepare workshop content folder
        run: |
          mkdir -p ${{ github.workspace }}/workshop_content/${{ github.event.inputs.app_id }}
          sudo chown -R 1000:1000 ${{ github.workspace }}/workshop_content

      - name: Parse Workshop IDs
        run: |
          IFS=',' read -r -a WORKSHOP_IDS <<< "${{ github.event.inputs.workshop_ids }}"
          echo "WORKSHOP_IDS=${WORKSHOP_IDS[*]}" >> $GITHUB_ENV

      - name: Download Workshop items sequentially as root
        run: |
          set -e
          STEAM_USERNAME="ruiiixx"
          STEAM_PASSWORD="S67GBTB83D3Y"

          for WORKSHOPID in ${{ env.WORKSHOP_IDS }}; do
            echo "Downloading Workshop ID $WORKSHOPID..."
            RETRY=0
            SUCCESS=0
            while [ $RETRY -lt 3 ] && [ $SUCCESS -eq 0 ]; do
              docker run --rm -u 0 -v ${{ github.workspace }}/workshop_content:/home/steam/Steam/steamapps/workshop/content cm2network/steamcmd \
                /home/steam/steamcmd/steamcmd.sh +login $STEAM_USERNAME $STEAM_PASSWORD \
                +workshop_download_item ${{ github.event.inputs.app_id }} $WORKSHOPID validate \
                +quit

              if [ $? -eq 0 ]; then
                SUCCESS=1
              else
                echo "Download failed, retrying..."
                RETRY=$((RETRY+1))
              fi
            done

            if [ $SUCCESS -eq 0 ]; then
              echo "Failed to download $WORKSHOPID after 3 attempts."
            else
              echo "Downloaded $WORKSHOPID successfully."
            fi

            ls -R ${{ github.workspace }}/workshop_content/${{ github.event.inputs.app_id }}/$WORKSHOPID || true
          done

      - name: Upload all Workshop items as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wallpaper-workshop-items
          path: ${{ github.workspace }}/workshop_content/${{ github.event.inputs.app_id }}
