name: DepotDownloaderMod EXE Downloader

on:
  workflow_dispatch:
    inputs:
      pubfileids:
        description: "Comma-separated Workshop pubfile IDs (e.g. 2898186348,1181580583)"
        required: true

      app_id:
        description: "Steam App ID"
        required: false
        default: "431960"

jobs:
  download:
    runs-on: windows-latest

    steps:
      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Download DepotDownloaderMod Release
        run: |
          curl -L -o release.rar https://github.com/SteamAutoCracks/DepotDownloaderMod/releases/latest/download/Release.rar

      - name: Extract RAR
        run: |
          7z x release.rar -orelease

      - name: Process Each pubfile ID
        shell: pwsh
        run: |
          $ids = "${{ github.event.inputs.pubfileids }}".Split(",")

          foreach ($id in $ids) {
            $trimmed = $id.Trim()
            echo "Processing pubfile ID: $trimmed"

            # Make dedicated output folder for each ID
            New-Item -ItemType Directory -Force -Path "output/$trimmed" | Out-Null

            # Run EXE for this pubfile
            & release/Release/net9.0/DepotDownloaderMod.exe `
              -app ${{ github.event.inputs.app_id }} `
              -pubfile $trimmed `
              -verify-all `
              -username "ruiiixx" `
              -password "S67GBTB83D3Y"

            # Move downloaded depot folder to output/<id>
            Get-ChildItem -Directory -Filter "depots" | ForEach-Object {
              Move-Item $_.FullName "output/$trimmed/depots" -Force
            }
          }

      - name: Upload all downloaded content
        uses: actions/upload-artifact@v4
        with:
          name: depotdownload
          path: output
