name: DepotDownloaderMod EXE Downloader

on:
  workflow_dispatch:
    inputs:
      pubfileids:
        description: "Comma-separated Workshop pubfile IDs"
        required: true

      app_id:
        description: "Steam App ID"
        required: false
        default: "431960"

      username:
        description: "Steam Username"
        required: true
        default: "ruiiixx" 

      password:
        description: "Steam Password (default public account)"
        required: false
        default: "S67GBTB83D3Y" 

jobs:
  download:
    runs-on: windows-latest

    steps:
      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Download DepotDownloaderMod Release
        run: |
          curl -L -o release.rar https://github.com/SteamAutoCracks/DepotDownloaderMod/releases/latest/download/Release.rar

      - name: Extract RAR
        run: |
          7z x release.rar -orelease

      - name: Process Each pubfile ID
        shell: pwsh
        run: |
          $ids = "${{ github.event.inputs.pubfileids }}".Split(",")
          $app = "${{ github.event.inputs.app_id }}"
          $user = "${{ github.event.inputs.username }}"
          $pass = "${{ github.event.inputs.password }}"
          $outputRoot = "depots/$app"
          New-Item -ItemType Directory -Force -Path $outputRoot | Out-Null

          foreach ($id in $ids) {
              $pubfile = $id.Trim()
              echo "Processing pubfile ID: $pubfile"

              # Run EXE for this pubfile
              & release/Release/net9.0/DepotDownloaderMod.exe `
                  -app $app `
                  -pubfile $pubfile `
                  -verify-all `
                  -username $user `
                  -password $pass

              # Move downloaded depot contents to depots/<app>/<pubfileid>
              $dest = "$outputRoot/$pubfile"
              New-Item -ItemType Directory -Force -Path $dest | Out-Null

              # Copy files from depot (19812784) to pubfile folder
              Get-ChildItem -Path "depots/$app/19812784" -Recurse | ForEach-Object {
                  $relative = $_.FullName.Substring((Get-Item "depots/$app/19812784").FullName.Length + 1)
                  $target = Join-Path $dest $relative
                  if ($_.PSIsContainer) {
                      New-Item -ItemType Directory -Force -Path $target | Out-Null
                  } else {
                      Copy-Item $_.FullName $target -Force
                  }
              }

              # Clean depot folder for next pubfile
              Remove-Item -Recurse -Force "depots/$app/19812784" -ErrorAction SilentlyContinue
          }

      - name: Upload all downloaded content
        uses: actions/upload-artifact@v4
        with:
          name: depotdownload
          path: depots
